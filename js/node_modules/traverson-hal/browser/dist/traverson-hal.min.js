!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).TraversonJsonHalAdapter=e()}}(function(){return function i(a,d,s){function u(r,e){if(!d[r]){if(!a[r]){var n="function"==typeof require&&require;if(!e&&n)return n(r,!0);if(l)return l(r,!0);var t=new Error("Cannot find module '"+r+"'");throw t.code="MODULE_NOT_FOUND",t}var o=d[r]={exports:{}};a[r][0].call(o.exports,function(e){return u(a[r][1][e]||e)},o,o.exports,i,a,d,s)}return d[r].exports}for(var l="function"==typeof require&&require,e=0;e<s.length;e++)u(s[e]);return u}({1:[function(e,r,n){"use strict";var a=e("halfred");function d(e){this.log=e,a.injectLogger(e)}function s(e,r,n){var t=new Error(e);return t.name=r,n&&(t.data=n),t}d.errors={InvalidArgumentError:"InvalidArgumentError",InvalidStateError:"InvalidStateError",LinkError:"HalLinkError",LinkMissingOrInvalidError:"HalLinkMissingOrInvalidError",EmbeddedDocumentsError:"HalEmbeddedDocumentsError"},d.mediaType="application/hal+json",d.prototype.findNextStep=function(e,r){if(null==r)throw s("Link object is null or undefined.",d.errors.InvalidArgumentError);if("object"!=typeof r)throw s("Links must be objects, not "+typeof r+": ",d.errors.InvalidArgumentError,r);if(!r.type)throw s("Link objects has no type attribute.",d.errors.InvalidArgumentError,r);switch(r.type){case"link-rel":return this._handleLinkRel(e,r);case"header":return this._handleHeader(e.lastStep.response,r);default:throw s("Link objects with type "+r.type+" are not supported by this adapter.",d.errors.InvalidArgumentError,r)}},d.prototype._handleLinkRel=function(e,r){var n=e.lastStep.doc,t=r.value;this.log.debug("parsing hal");var o,i={doc:n,halResource:a.parse(n),parsedKey:function(e){var r=e.match(/(.*)\[(.*):(.*)\]/);if(r)return{mode:"secondary",key:r[1],secondaryKey:r[2],secondaryValue:r[3],index:null};if(r=e.match(/(.*)\[(\d+)\]/))return{mode:"index",key:r[1],secondaryKey:null,secondaryValue:null,index:r[2]};if(r=e.match(/(.*)\[\$all\]/))return{mode:"all",key:r[1],secondaryKey:null,secondaryValue:null,index:null};return{mode:"first",key:e,secondaryKey:null,secondaryValue:null,index:null}}(t),linkStep:null,embeddedStep:null};return(o=i).halResource.hasCuries()&&(o.parsedKey.curie=o.halResource.reverseResolveCurie(o.parsedKey.key)),function(e,r){var n=e.halResource.linkArray(e.parsedKey.key);n||(n=e.halResource.linkArray(e.parsedKey.curie));if(!n||0===n.length)return;switch(e.parsedKey.mode){case"secondary":!function(e,r,n){for(var t=0;t<r.length;t++){var o=r[t][e.parsedKey.secondaryKey];if(null!=o&&o==e.parsedKey.secondaryValue)return r[t].href?(n.debug("found hal link: "+r[t].href),e.linkStep={url:r[t].href}):e.linkError="The link "+e.parsedKey.key+"["+e.parsedKey.secondaryKey+":"+e.parsedKey.secondaryValue+"] exists, but it has no href attribute."}e.linkError=e.parsedKey.key+"["+e.parsedKey.secondaryKey+":"+e.parsedKey.secondaryValue+"] requested, but there is no such link."}(e,n,r);break;case"index":!function(e,r,n){if(!r[e.parsedKey.index])return e.linkError="The link array "+e.parsedKey.key+" exists, but has no element at index "+e.parsedKey.index+".";if(!r[e.parsedKey.index].href)return e.linkError="The link "+e.parsedKey.key+"["+e.parsedKey.index+"] exists, but it has no href attribute.";n.debug("found hal link: "+r[e.parsedKey.index].href),e.linkStep={url:r[e.parsedKey.index].href}}(e,n,r);break;case"first":!function(e,r,n){for(var t,o=0;o<r.length;o++)if(r[o].href){t=r[o];break}t&&(1<r.length&&n.warn("Found HAL link array with more than one element for key "+e.parsedKey.key+", arbitrarily choosing index "+o+", because it was the first that had a href attribute."),n.debug("found hal link: "+t.href),e.linkStep={url:t.href})}(e,n,r);break;case"all":break;default:throw s("Illegal mode: "+e.parsedKey.mode,d.errors.InvalidArgumentError)}}(i,this.log),function(e,r){r.debug("checking for embedded: "+e.parsedKey.key+(e.parsedKey.index?e.parsedKey.index:""));var n=e.halResource.embeddedArray(e.parsedKey.key);if((!n||0===n.length)&&"all"!==e.parsedKey.mode)return;switch(r.debug("Found an array of embedded resource for: "+e.parsedKey.key),e.parsedKey.mode){case"secondary":!function(e,r,n){for(var t=0;t<r.length;t++){var o=r[t][e.parsedKey.secondaryKey];if(null!=o&&o==e.parsedKey.secondaryValue)return n.debug("Found an embedded resource for: "+e.parsedKey.key+"["+e.parsedKey.secondaryKey+":"+e.parsedKey.secondaryValue+"]"),e.embeddedStep={doc:r[t].original()}}e.embeddedError=e.parsedKey.key+"["+e.parsedKey.secondaryKey+":"+e.parsedKey.secondaryValue+"] requested, but the embedded array "+e.parsedKey.key+" has no such element."}(e,n,r);break;case"index":!function(e,r,n){if(!r[e.parsedKey.index])return e.embeddedError="The embedded array "+e.parsedKey.key+" exists, but has no element at index "+e.parsedKey.index+".";n.debug("Found an embedded resource for: "+e.parsedKey.key+"["+e.parsedKey.index+"]"),e.embeddedStep={doc:r[e.parsedKey.index].original()}}(e,n,r);break;case"all":!function(e,r,n){var t=e.halResource.original()._embedded&&e.halResource.original()._embedded[e.parsedKey.key];t?t instanceof Array||(t=[].concat(t)):t=[];e.embeddedStep={doc:t}}(e);break;case"first":!function(e,r,n){1<r.length&&n.warn("Found HAL embedded resource array with more than one element  for key "+e.parsedKey.key+", arbitrarily choosing first element.");e.embeddedStep={doc:r[0].original()}}(e,n,r);break;default:throw s("Illegal mode: "+e.parsedKey.mode,d.errors.InvalidArgumentError)}}(i,this.log),function(e,r,n){var t;t=n||"all"===e.parsedKey.mode?e.embeddedStep||e.linkStep:e.linkStep||e.embeddedStep;{if(t)return t;var o="Could not find a matching link nor an embedded document for "+r+".",i=d.errors.LinkError;throw e.linkError&&(o+=" Error while resolving linked documents: "+e.linkError,i=d.errors.LinkMissingOrInvalidError),e.embeddedError&&(o+=" Error while resolving embedded documents: "+e.embeddedError,e.linkError&&!n||(i=d.errors.EmbeddedDocumentsError)),s(o+=" Document: "+JSON.stringify(e.doc),i,e.doc)}}(i,t,e.preferEmbedded)},d.prototype._handleHeader=function(e,r){switch(r.value){case"location":var n=e.headers.location;if(!n)throw s("Following the location header but there was no location header in the last response.",d.errors.InvalidStateError);return{url:n};default:throw s("Link objects with type header and value "+r.value+" are not supported by this adapter.",d.errors.InvalidArgumentError,r)}},r.exports=d},{halfred:2}],2:[function(e,r,n){var t=e("./lib/parser"),o=e("./lib/resource"),i=!1,a="undefined"!=typeof console&&"function"==typeof console.warn?console:{log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}};r.exports={parse:function(e){return new t(a).parse(e,i)},injectLogger:function(e){a=e},enableValidation:function(e){i=null==e||e},disableValidation:function(){i=!1},Resource:o}},{"./lib/parser":4,"./lib/resource":5}],3:[function(e,r,n){"use strict";function t(){1<=arguments.length?this._array=arguments[0]:this._array=[]}t.prototype.array=function(){return this._array},t.prototype.isEmpty=function(e){return 0===this._array.length},t.prototype.push=function(e){var r=this._array.slice(0);return r.push(e),new t(r)},t.prototype.pop=function(){return new t(this._array.slice(0,this._array.length-1))},t.prototype.peek=function(){if(this.isEmpty())throw new Error("can't peek on empty stack");return this._array[this._array.length-1]},r.exports=t},{}],4:[function(e,r,n){"use strict";var d,f=e("./resource"),t=e("./immutable_stack"),s={href:{required:!0,defaultValue:null},templated:{required:!1,defaultValue:!1},type:{required:!1,defaultValue:null},deprecation:{required:!1,defaultValue:null},name:{required:!1,defaultValue:null},profile:{required:!1,defaultValue:null},title:{required:!1,defaultValue:null},hreflang:{required:!1,defaultValue:null}};function o(e){d=e}function h(e,r,n){if(null==e)return e;var t,o,i,a,d,s,u,l=function(e,r,n){null!=(e=m(e,b,r,n))&&null!=e.self||v("Resource does not have a self link",r,n);return e}(e._links,r,n.push("_links")),c=(t=l)?t.curies:[],p=(o=e._embedded,i=r,a=n.push("_embedded"),null!=(d=m(o,k,i,a))&&Object.keys(d).forEach(function(n){d[n]=d[n].map(function(e){var r=h(e,null!=i?[]:null,a.push(n));return r._original=e,r})}),d),y=new f(l,c,p,r);return s=e,u=y,Object.keys(s).forEach(function(e){"_links"!==e&&"_embedded"!==e&&(u[e]=s[e])}),y._original=e,y}function m(d,s,u,l){if(null==d)return d;var c={};return Object.keys(d).forEach(function(e){var r,n,t,o,i,a;c[e]=(n=d[r=e],t=s,o=u,i=l,a=n,"[object Array]"===Object.prototype.toString.call(a)?n.map(function(e){return t(r,e,o,i)}):[t(r,n,o,i)])}),c}function b(r,e,n,t){if("object"!=typeof e)throw new Error("Link object is not an actual object: "+e+" ["+typeof e+"]");var o,i,a=(o=e,i={},Object.keys(o).forEach(function(e){i[e]=o[e]}),i);return Object.keys(s).forEach(function(e){null==a[e]&&(s[e].required&&v("Link misses required property "+e+".",n,t.push(r)),null!=s[e].defaultValue&&(a[e]=s[e].defaultValue))}),a.deprecation&&d.warn("Link "+u(t.push(r))+" is deprecated, see "+a.deprecation),!0!==a.templated&&!1!==a.templated&&(a.templated=!1),n&&a.href&&0<=a.href.indexOf("{")&&!a.templated&&v('Link seems to be an URI template but its "templated" property is not set to true.',n,t.push(r)),a}function k(e,r){return r}function v(e,r,n){r&&r.push({path:u(n),message:e})}function u(e){for(var r="$.",n=0;n<e.array().length;n++)r+=e.array()[n]+".";return r=r.substring(0,r.length-1)}o.prototype.parse=function(e,r){return h(e,r?[]:null,new t)},r.exports=o},{"./immutable_stack":3,"./resource":5}],5:[function(e,r,n){"use strict";function t(e,r,n,t){this._links=e||{},this._initCuries(r),this._embedded=n||{},this._validation=t||[]}function o(e,r){return null!=e?e[r]:null}function i(e,r,n){n=n||0;var t=o(e,r);return null!=t&&1<=t.length?t[n]:null}t.prototype._initCuries=function(e){if(this._curiesMap={},e){this._curies=e;for(var r=0;r<this._curies.length;r++){var n=this._curies[r];this._curiesMap[n.name]=n}}else this._curies=[];this._preResolveCuries()},t.prototype._preResolveCuries=function(){this._resolvedCuriesMap={};for(var e=0;e<this._curies.length;e++){var r=this._curies[e];if(r.name)for(var n in this._links)"curies"!==n&&this._preResolveCurie(r,n)}},t.prototype._preResolveCurie=function(e,r){this._links[r];var n=r.split(/:(.+)/),t=n[0];if(e.name===t)if(e.templated&&1<=n.length){var o=e.href.replace(/(.*){(.*)}(.*)/,"$1"+n[1]+"$3");this._resolvedCuriesMap[o]=r}else this._resolvedCuriesMap[e.href]=r},t.prototype.allLinkArrays=function(){return this._links},t.prototype.linkArray=function(e){return o(this._links,e)},t.prototype.link=function(e,r){return i(this._links,e,r)},t.prototype.hasCuries=function(e){return 0<this._curies.length},t.prototype.curieArray=function(e){return this._curies},t.prototype.curie=function(e){return this._curiesMap[e]},t.prototype.reverseResolveCurie=function(e){return this._resolvedCuriesMap[e]},t.prototype.allEmbeddedResourceArrays=function(){return this._embedded},t.prototype.embeddedResourceArray=function(e){return o(this._embedded,e)},t.prototype.embeddedResource=function(e,r){return i(this._embedded,e,r)},t.prototype.original=function(){return this._original},t.prototype.validationIssues=function(){return this._validation},t.prototype.allLinks=t.prototype.allLinkArrays,t.prototype.allEmbeddedArrays=t.prototype.allEmbeddedResources=t.prototype.allEmbeddedResourceArrays,t.prototype.embeddedArray=t.prototype.embeddedResourceArray,t.prototype.embedded=t.prototype.embeddedResource,t.prototype.validation=t.prototype.validationIssues,r.exports=t},{}]},{},[1])(1)});